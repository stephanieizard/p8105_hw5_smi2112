---
title: "P8105 Homework 5"
author: "Stephanie Izard"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

##Problem 1

####Creating dataframe:
* Step 1: Creating a string containing all file names

```{r}
file_names <- list.files(path = "./data/q1/", full.names = TRUE)
```

* Step 2: Iterating over file names, reading in data for each subject

```{r}
read_ppt_info <- function(file_names) {
  z = read_csv(file_names)
  z
}

ppt_info <- file_names %>% 
  tibble(file_name = .) %>% 
  group_by(file_name) %>% 
  nest() %>% 
  mutate(data = map(.$file_name, read_ppt_info)) %>% 
  unnest()
```

* Step 3: Tidying the result

```{r}
ppt_info <- ppt_info %>% 
  mutate(file_name = str_replace(file_name, "./data/q1/", ""),
         file_name = str_replace(file_name, ".csv", "")) %>% 
  rename(ppt_id = file_name) %>% 
  mutate(ppt_unique_id = c(1:20)) %>% 
  gather(key = "week", value = "measure", week_1:week_8) %>% 
  mutate(week = str_replace(week, ".*_", ""))
```

#####Spaghetti plot 

```{r}
ppt_info %>% 
  mutate(week = as.numeric(week)) %>%
  separate(col = ppt_id, into = c("treatment", "number"), by = "_") %>% 
  group_by(treatment, ppt_unique_id) %>% 
  ggplot(aes(x = week, y = measure, group = ppt_unique_id, color = treatment)) +
    geom_line() +
    labs(x = "Week", y = "Measure", title = "Participant observations over time") + 
    viridis::scale_color_viridis(option = "cividis", name = "Treatment group", discrete = TRUE, label = c("Control", "Experimental")) +
    theme_minimal()
```

Comments: (on difference over time)

##Problem 2

####Reading in the raw homicide data from the Washington Post

```{r}
homicide_data <- read_csv("./data/q2/homicide-data.csv") 
```

About the raw data: (describe some stuff here)

####Creating variables and nesting data

```{r}
homicide_data_nest <- homicide_data %>% 
  unite(city_state, city:state, sep = ", ", remove = FALSE) %>% 
  mutate(case_status = if_else(disposition == "Closed without arrest", "unsolved", 
                               if_else(disposition == "Open/No arrest", "unsolved", "solved"))) %>% 
  mutate(city_state = recode(city_state, "Tulsa, AL" = "Tulsa, OK")) %>% 
  group_by(city_state) %>% 
  nest()
```

####Summarizing total and unsolved homicides

```{r}
homicide_data_total <- homicide_data_nest %>% 
  unnest() %>% 
  group_by(city_state) %>% 
  summarize(total_cases = n())

homicide_data_unsolved <- homicide_data_nest %>% 
  unnest() %>% 
  filter(case_status == "unsolved") %>% 
  group_by(city_state) %>% 
  summarize(total_unsolved = n())

homicide_data <- inner_join(homicide_data_total, homicide_data_unsolved, by = "city_state") 

homicide_data %>% 
  rename("City" = city_state,
         "Total Homicides" = total_cases,
         "Unsolved Homicides" = total_unsolved) %>% 
  knitr::kable()
```

####Proportion of unsolved homicides for Baltimore, MD

```{r}
md_only <- homicide_data_nest %>% 
  unnest() %>% 
  filter(city_state == "Baltimore, MD") %>% 
  mutate(case_status = recode(case_status, "unsolved" = 0, "solved" = 1))

prop_test <- prop.test(table(md_only$case_status))

prop_test %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high) %>% 
  rename("Proportion Unsolved" = estimate, 
         "CI low" = conf.low, 
         "CI high" = conf.high) %>% 
  knitr::kable()
```

####Proportion of unsolved homicides for every city

```{r}
city_nest <- homicide_data %>% 
  group_by(city_state) %>% 
  nest() 

est_prop_unsolved = function(df) {
  
  unsolved_data = prop.test(df$total_unsolved, df$total_cases)
  
  broom::tidy(unsolved_data) %>% 
    select(estimate, conf.low, conf.high)
}

city_unsolved_cases <-
  city_nest %>% 
  mutate(prop_unsolved = map(data, est_prop_unsolved)) %>% 
  unnest()

city_unsolved_cases %>% 
  select(city_state, estimate, conf.low, conf.high) %>% 
  rename("City" = city_state,
         "Proportion Unsolved" = estimate,
         "CI low" = conf.low, 
         "CI high" = conf.high) %>% 
  knitr::kable()
```

####Plotting estimates and CIs for each city

```{r, fig.height = 9, fig.width = 9}
city_unsolved_cases %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
    geom_point() +
    geom_errorbar(aes(ymax = conf.high, ymin = conf.low)) +
    labs(x = "City, State", 
         y = "Proportion of Unsolved Homicides", 
         title = "Proportion of Unsolved Homicides per City",
         caption = "Error bars represent the 95% confidence interval") +
    coord_flip() +
    theme_minimal()
```










